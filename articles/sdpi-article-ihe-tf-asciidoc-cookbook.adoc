= IHE TF AsciiDoc Cookbook
0.1, 2022.09.06: AsciiDoc article / repo wiki
:doctype: book
:xrefstyle: short
:toc-title: Contents
:toc: left
:toclevels: 2
:sectnums:
:icons: font
:imagesoutdir: images/
:imagesdir: images/

WARNING: This is a straw-man article. Content hackers welcomed!  Add content requests to section ++<<Topics Parking Lot>>++ below.

== Cookbook Overview
This article provides a *_handy_* reference place for the conventions and templates that editors will apply in creating content for the SDPi specification.  It is organized so as to help with specific editorial tasks (e.g., references, images, tables, metadata, etc.).

Related articles that support the information below include:

* https://github.com/IHE/sdpi-fhir/blob/50ace3692b9299cdfcea434501df87b192f5220c/SDPi_Supplement/articles/sdpi-article-asciidoc-cheat-sheet.adoc[AsciiDoc Cheat Sheet]
* link:SDPi-File-Organization-Scheme[SDPi File Organization Scheme]

There are a few methods to review the HTML that will be rendered from the AsciiDoc sources:

. IntelliJ Editor has quick view panes that can be used during content development +
. An "HTML" that can be used for creation of a .html version of the file (and included files) being edited
. GitHub Actions can be used to view the fully rendered document:
.. Push the local branch to remote; this will automatically trigger "Verify and upload SDPi supplement" workflow action
.. Use your browser to navigate to https://github.com/IHE/sdpi-fhir/actions[sdpi-fhir gihub actions page
.. Select "All workflows" or the "Verify and ..." tab
.. Note that it typically takes a minute or two to complete the workflow action -- status will be displayed on the right side of your push's row
.. Select your branches latest upload (push remote)
.. IF the action was successful, there will be listed in the "Artifacts" section; click on the artifact Name to download a ZIP of the rendered document.
.. Extract the ZIP, select the "singlepage" subfolder and open the sdpi-supplement.html document

Enjoy AsciiDoc content creation!

== Asciidoc Source Conventions

The following subsections specify conventions for the writing of Asciidoc markup.
It makes use of [Backus-Naur forms](https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form), which may include
[Regular expressions](https://en.wikipedia.org/wiki/Regular_expression) (signified by enclosing slashes) to describe
grammars for acceptable characters of symbols.

NOTE:  Following sections are in alphabetical order

=== Footnotes

##See example from supplement introduction; note that this example puts the footnotes in the bottom of the table vs. page ... matter?
##

=== Identifier naming

Asciidoc leverages identifiers for cross-referencing artifacts in Asciidoc markup.
The following rule specifies is a general naming convention for identifiers that is used throughout this section:

[source]
----
Name ::= /^[a-z0-9_]+$/
----

Name:: Custom name that contains small letters, digits and underscores only.

==== Identifier prefix

Identifiers shall be made up from the following rules:

[source]
----
Volume = 'vol0' | vol1' | 'vol2' | 'vol3'
ReferenceType ::= 'clause' | 'appendix' | 'listing' | 'figure' | 'table' | 'example' | 'ref'

BlockIdentifier ::= Volume '_' ReferenceType '_' Name
----

Volume:: Target volume.
ReferenceType:: The referenced block type.

.Example of including a clause name
====
[source,asciidoc]
----
[#vol2_clause_transactions]
== Transactions

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore
magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd
gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
----
====

==== Variables

Variables can be used to avoid repeating names or URIs in the Asciidoc source code. Variables shall be made up from the following rules:

[source]
----
VariableType ::= 'uri'

VariableName ::= 'var_' + [ VariableType + '_' ] + Name
----

VariableType:: Type of the variable, currently URIs/URLs are to be specifically designated.

==== Definitions

Definition Names are just arbitrary character sequences according to the following rule:

[source]
----
DefinitionName ::= Name
----

==== Actors

Actor Names are definition names with a specific prefix:

[source]
----
ActorName ::= 'actor_' + Name
----

=== Image paths

Images are stored in the `images` sub-folder including any diagrams generated by the Asciidoc Diagram plugin.

=== Listing paths

Code listings are stored in the `listings` sub-folder.

=== Nested Tables

##See example in supplement introduction
###

=== Plant UML diagrams

PlantUML diagram sources are stored in the `plantuml` sub-folder.

- A PlantUML diagram source shall be included by using the `include` directive (rather than inline)
- A PlantUML diagram source shall contain `skinparam dpi 300` for appropriate high-resolution rendering
- If no custom color palette is applied on a PlantUML diagram, the PlantUML diagram's source shall contain `skinparam monochrome true` for monochrome rendering

PlantUML diagram target names shall start with `puml` to easily identify any generated Plant UML artifacts in the
`images` folder.

[source]
----
PlantUmlTarget = 'puml-' Name
----

.Example of including a PlantUML diagram.
Note the leading `puml-` at the target option.

====
[source,asciidoc]
----
.Diagram title
[[vol2_figure_xyz]]
[plantuml, target=puml-vol2-figure-xyz, format=svg, reftext='{figure-caption} {counter:refnum}']
....
include::../plantuml/vol2-figure-xyz.puml[]
....
----
====

=== SVG Graphics -- PowerPoint to SVG + InkScape

For those graphics that are not PlantUML based, the preferred format is Scalable Vector Graphics (SVG) format.  Since many of content developers utilize Microsoft PowerPoint as their graphics editor of choice, getting from a PowerPoint slide to an SVG file that renders well in AsciiDoc is a bit of a journey.  The following tools and process -- though a bit laborious -- works well and reliably.

==== InkScape SVG Editing Tool
Before you begin, install the InkScape SVG editing tool.  This open source tool is available for free download at:  https://inkscape.org/release/1.1.2/platforms/ [inkscape.org/release/1.1.2/platforms].

[none]
* Note:  _Version 1.1.2 should be downloaded at this point due to some feature changes in more recent versions.  This should be rectified in the Q1 2023 update._

When installing, accept the normal "default" configuration options.  Our use of the tool is very basic!

==== PowerPoint to SVG
The first part of the process is to convert a PowerPoint graphic to SVG format:

. PowerPoint file should have a *_single slide with the graphics_* to be converted.  File should be named according to the file naming conventions (See sdpi-fhir wiki article link:SDPi-File-Organization-Scheme#file-naming-conventions[SDPi File Organization Scheme -- File Naming Conventions]).

.  During development & conversion, maintain the files (.pptx & .svg) in a separate local directory.  Ultimately, they will be moved to the appropriate directories in the github repository (per the above article's conventions)

. For the power point slide:

** Select All objects (e.g., ctrl^a) to make sure only the objects in your graphic are included - delete any other objects on the slide (e.g., transparent boxes that don't render).

** Hide any background graphics:  Design -> Format Background -> select _Hide background graphics_

. Convert to SVG:  File -> Save As -> Scalable Vector Graphics Format (*.svg)

*** Note:  Though there is only one slide per file, select "Just This One" when prompted for "Which slides do you want to export?"

Now you should have an SVG version of the graphic; hopefully in the same directory as the source .pptx file.

==== SVG to Final Cropped Version using InkScape
When PowerPoint exprts to SVG, it also includes the background area, which will display as a small graphic on a large white background.  To crop the SVG to the final version that will be rendered in the AsciiDoc file, follow the following steps:

. Load the .svg file into InkScape (see above for installing the tool)
. Delete the background layer:  double click anywhere on the background whitespace, press Del key.
. Crop the borders to 15 pixels around the graphic:
** File -> Document Properties -> Page -> _Resize page to content ..._
** Set Top / Bottom / Left / Right to 15.0
** Click "_Resize page to drawing or selection_"
** There should now be a box around the graphic with a 15 pixel border
. Add a "background box" behind the graphic:
** From the menu on the left of the tool's window, select the red rectangle ("Create Rectangles and Squares")
** Draw a box on top of the cropped graphic
** Change the box to white (click white on the color strip at the bottom of the tool's window)
** Move the box to behind the graphic:  Object -> Lower to Bottom
. Save edited SVG file (to your working directory)

==== Move SVG Graphic Files to Repository
The final step is to move both the source (pptx) and final SVG files from your working folder to the designated folders in the sdpi-fhir repository:

* SVG to SDPi_Supplement/asciidoc/images
* PPTX to SDPi_Supplement/sources

Check the AsciiDoc source where the graphic is included to ensure that it is properly formatted.

=== PNG & JPG & Other Automatic Image Formats

In general, AsciiDoc automatically handles other image formats based on the file name extension (e.g., myGraphic.png).

[source]
----
image::../../asciidoc/images/ihe-logo.svg[]
----

Which should render as:

image::../../asciidoc/images/ihe-logo.svg[]

NOTE: __You may need to experiment with paths to locate the image file. Use `..` for the parent folder; this one is in the `<project-root>/asciidoc/images` folder. __

NOTE: __ Two colons "::" are needed if the graphic is on a line by itself; if it is in-line with other text, then a single colon ":" should be used.__


Additional information is provided on the https://docs.asciidoctor.org/asciidoc/latest/macros/image-format/[AsciiDoc Specify Image Format] page.  For general file types and formats information, consult the https://developer.mozilla.org/en-US/docs/Web/Media/Formats/Image_types[Mozilla Image File Type and Format Guide].

=== Section Numbering Challenges

IHE technical framework _supplement_ documents are intended to be integrated into the main IHE DEV Technical Framework document.  This means that section numbering in the supplement is _discontiguous_ and is based on where it will ultimately be inserted.  AsciiDoc of course does not support discontiguous section numbering and as a result, the content has to be annotated with directions for a post processor (i.e., asciidoc-converter tool) to render the proper section numbering in the HTML output.

==== Setting the Section Offset and Level

##add content here###

==== Appendix Letters

##add content here##

=== Superscript / Subscript

##Bring example from supplement overview using ^...^ and ~...~ respectively
##

=== Text Box for Editor's Instructions
Many of the IHE Technical Framework Supplement sections include instructions for the editor who will ultimately migrate the supplemenbt content into the main (final text) Technical Framework specification.  These instructions are typically contained in a text box at the start of a section.

For AsciiDoc, this text box is realized by defining a one-cell table, as follows:

[source,asciidoc]
----
[%noheader]
[%autowidth]
[cols="1"]
|===
|Add the following _*new or modified*_ actors to the IHE Technical Frameworks General Introduction Appendix A
|===
----

This would result in the following text:

[%noheader]
[%autowidth]
[cols="1"]
|===
|Add the following _*new or modified*_ actors to the IHE Technical Frameworks General Introduction Appendix A
|===

=== Term & Acronym Definitions and References

Specialized terms and acronyms should be added to the TF-0 Glossary table and referenced appropriately throughout the specification text.  For example, the special term "Participant Key Purposes" and acronmy "PKP" would be added to the glossary table as follows:


[source]
----
| [[term_participant_key_purposes,Participant Key Purposes (PKP)]] Participant Key Purposes
| These generally refer to the ISO/IEEE 11073-1070x standards that provide a consensus set of risk control measures aligned with the four core <<acronym_mdi>> functions:  <<term_plug_and_trust>>, reporting, alerting & external control.
|
| [[acronym_pkp,PKP]] PKP
----

Subsequent references in the AsciiDoc specification should utilize "term_" and "acronym_".  If the acronym is only used locally, with in a single section or subsection, then it should be defined there at the outer most level and not formalized in the IHE Glossary.

NOTE:  The IHE TF-0 Appendix D glossary collects specialized (defined) terms used throughout all the IHE domain technical framework specifications.  Any conflicts with other defined terms and acronyms may result in updating to the specifications.

=== Paragraphs - LONG Paragraph Conventions
Paragraphs with multiple sentences -- which may be deemed "long" by some editors and readers! -- should separate each sentence with a single new-line.
This will make the AsciiDoc source much more readable without resulting in any format changes when rendered.
For example:

[source, asciidoc]
----
First paragraph - first sentence.
Second sentence.
Third sentence.

Second paragraph ...
----

Would be rendered as:
[none]
. First paragraph - first sentence.
Second sentence.
Third sentence.

. Second paragraph ...

== IHE Style Guide Conventions
IHE technical framework specifications follow a set of style conventions and associated templates.  Though this is to some degree in "flux" given the movement to HTML-based specifications, the style conventions in the subsections below help ensure consistency in the IHE DEV SDPi content.

=== Table and Figure Numbering

#TODO:  section-based sequential table numbering + referencing w/ AsciiDoc examples#

=== Bullet List Conventions

#TODO:  Review that the following is agreeable by the SDPi Editors#

For a bulleted list of items, the final "full stop" character of each non-final bullet should be ";" semicolon, with the final bullet ending in a "." period.  For example:

. First bullet;
. Second bullet;
. Final Bullet.

[#semantic-markup]
== Semantic markup
https://docs.asciidoctor.org/asciidoctorj/latest/[Asciidoctor], which converts these files into other formats (e.g., html, pdf), has been https://docs.asciidoctor.org/asciidoctorj/latest/extensions/extensions-introduction/[extended] to process domain specific content for the supplement. These extensions provide semantic markup of content that is used to automatically generate, for example, implementation conformance statement tables and export requirements and use cases in JSON format for external tooling (see https://profiles.ihe.net/DEV/SDPi/index.html#vol1_appendix_a_requirements_management_for_p_n_t_interperability[requirements management for plug-and-trust interoperability]). 

Content extracted, using markup in the source described below, and exported, to `sdpi-supplement/referenced-artifacts/` in JSON format includes:

* `sdpi-profiles.json`: all profiles (e.g., SDPi), including actors and options defined, and the transactions, content modules and use-cases referenced,
* `sdpi-content-modules.json`: content modules (e.g., SDC/BICEPS, etc),
* `sdpi-transactions.json`: collects transactions and the roles of actors in the transactions,
* `sdpi-requirements.json`: all requirements, 
* `sdpi-use-cases.json`: all use cases.

NOTE: the extensions are written in Kotlin and may be found, along with the document processing tools, in `.ci/asciidoc-converter`. In Windows, run `build_document.bat` to process the Asciidoc source files. 

Most content is defined by roles attached to an appropriate section. For example, a section that includes the `content-module` role will define a _content module_. The table below summarizes the roles available to mark up content. 

|===
| Content | Role | Identifier attribute | Parent scope

| <<semantic-content-modules,Content module>> | `content-module` | `content-module-id` | global
| <<semantic-transactions,Transaction>> | `transaction` | `transaction-id` | global
| <<semantic-profiles,Profile>> | `profile` | `profile-id` | global
| Profile option | `profile-option` | `profile-option-id` | Profile
| Actor | `actor` | `actor-id` | Profile, Profile option
| <<use-case,Use case>> | `use-case` | `use-case-id` | global
| Use case background | `use-case-background` | &mdash; | Use case
| Use case scenario | `use-case-scenario` | &mdash; | Use case
| Use case steps | `use-case-steps` | &mdash; | Use case scenario
| Gateway | `gateway` | `gateway-id` | global
| Protocol | `protocol` | `protocol-id` | global
|===

NOTE: <<semantic-requirements>> are defined in a custom block. 

[#semantic-profiles]
=== Defining profiles

Profiles define <<semantic-actors,actors>> and compose a set of transactions, use cases and content modules. They are defined within a single AsciiDoc section that includes definitions for all the profile's actors and references to relevant transactions, use-cases and content modules. Profiles may also define optional parts, such as support for a discovery proxy. Each option may define its own actors and reference a set of transactions, use cases and content modules. 

The `profile` and `profile-option` roles mark sections defining profiles and options within profiles, respectively. A document-unique id is required for each profile and profile option, set using the `profile-id` and `profile-option-id` attributes, respectively. An <<defining-oids,object identifier (oid)>> is required for each profile but not for profile options (currently). The fragment below illustrates the definition of a profile and two profile options. 

NOTE: The document structure is used to associate information, such as actors and references to transactions or use cases, with a profile so these must be defined in sub-sections to the document section defining the profile. 

[source,asciidoc]
----
[role="profile",profile-id="SDPi-P",oid-arcs=.11]
== Plug-and-trust (SDPi-P) Profile

The SDPi-Plug-and-trust SDPi-P) Profile supports foundational seamless connectivity...

[role="profile-option",profile-option-id="discovery proxy"]
=== Managed discovery proxy option

The managed discovery proxy supports discovery of SOMDS participants through a well-known proxy service...

[role="profile-option",profile-option-id="ad-hoc-discovery"]
=== Ad-hoc discovery option

Ad-hoc discovery supports discovery of SOMDS participants through multi-cast broadcast messages...

----

[#semantic-actors]
==== Defining actors

The (abbreviated) example below illustrates the AsciiDoc source defining three actors. 

[source,asciidoc]
----
[#vol1_clause_sdpi_p_somds_participant, role="actor",actor-id="somds-participant",oid-arcs=.40]
==== SOMDS Participant

Actor Summary Definition:
[none]
. A foundational abstract actor that provides the...

[#vol1_clause_sdpi_p_somds_provider, role="actor",actor-id="somds-provider",oid-arcs=.41]
==== SOMDS Provider

Actor Summary Definition:
[none]
. A participant that provides at least one...

[#vol1_clause_sdpi_p_somds_consumer, role="actor",actor-id="somds-consumer",oid-arcs=.30]
==== SOMDS Consumer

Actor Summary Definition:
[none]
. A participant that discovers and...

----

Attaching the `actor` role to a section marks it as an actor. A (document-unique) identifier must be defined in the `actor-id` attribute. An <<defining-oids,object identifier (oid)>> must be set for each actor. The `reftext` attribute or, if `reftext` is missing, the section title is used for the actor label. 

[#semantic-actor-options]
==== Actor option sections

Options, which may impose additional transaction obligations on actors, may be defined using the `actor-option` role. The abbreviated example below shows the AsciiDoc source to tag sections defining actor options. 

[source,asciidoc]
----
role=actor-option,actor-option-id=remote_alert_signaling]
==== Remote Alert Signaling

This option will enable...
----

Attaching the `actor-option` role to a section marks it as an actor option. A (document-unique) identifier must be defined in the `actor-option-id` 
attribute. <<semantic-profile-ref-transactions,Transactions included>> within the section are associated with the actor option either defining 
or overriding obligations that apply when the actor option is selected for a participant. 


[#semantic-profile-ref-transactions]
==== Referencing transactions

A profile, profile option or actor option references a <<semantic-transactions,transaction>> using the `sdpi_include_transaction` [include processor](https://docs.asciidoctor.org/asciidoctorj/latest/extensions/include-processor/) and declares the obligations of contributors. 

There are two forms for `sdpi_include_transaction`. The first form defines obligations for the actor roles defined in the transaction. That is, only the contribution (`initiator`, `receiver`, `responder`) and obligation (`required`, `optional`) are required. It is not necessary to repeat the actor. For example:

[source, asciidoc]
----
sdpi_include_transaction::DEV-23[initiator="required", receiver="optional"]
sdpi_include_transaction::DEV-47[initiator="optional", responder="required"]
----

The second form defines obligations for specific profile actors. This form is used to define obligations for profile actors (grouped actors) when the transaction's actor roles are defined for base actors. For example, transaction defines roles for consumers and providers (actors in the base profile; SDPi-P). Create a separate `sdpi_include_transaction` and include the `actor-id` attribute to reference this transaction and assign obligations to actors from the reporting profile (SDPi-R). For example:

[source,asciidoc]
---
sdpi_include_transaction::DEV-35[actor-id="somds_medical_data_consumer",initiator="required"]
sdpi_include_transaction::DEV-35[actor-id="somds_medical_data_provider",responder="required"]
sdpi_include_transaction::DEV-35[actor-id="somds_dec_gateway",initiator="required"]
---

In each form, specify the:

* <<semantic-transactions,transaction>> id as the directive target (e.g., `DEV-23`, `DEV-47`),
* obligation (that is, `required` or `optional`) for each contribution (that is, `initiator`, `receiver` or `responder`) in attributes; the contributions for included transactions must match those defined in the <<semantic-transaction,transaction>>. 

NOTE: Transactions included in a profile-option section apply to the option. Transactions included a actor-option section apply to the actor option. Transactions included a profile section apply to the profile. 

[#semantic-profile-ref-content-modules]
==== Referencing content-modules

A profile, or profile-option, references a <<semantic-content-module,content module>> using the `sdpi_include_content_module` [include processor](https://docs.asciidoctor.org/asciidoctorj/latest/extensions/include-processor/) and declares the actor and obligation of the actor for the profile. Include the content module for each actor with an obligation in the profile. For example:

[source,asciidoc]
----
===== BICEPS Content Creator
sdpi_include_content_module::biceps[actor-id="biceps-content-creator", support="required"]
sdpi_include_content_module::pump[actor-id="biceps-content-creator",support="optional"]
   :
   :

===== BICEPS Content Consumer
sdpi_include_content_module::biceps[actor-id="biceps-content-consumer", support="required"]
sdpi_include_content_module::pump[actor-id="biceps-content-consumer",support="optional"]
   :
   :
----

Note, specify the:

* <<semantic-content-module,content module>> id as the directive target (e.g., `biceps`, `pump`),
* <<semantic-actors,actor's>> id using the `actor-id` attribute,
* obligation of the actor in the `support` attribute (that is, `required` or `optional`). 

NOTE: Content modules included in a sub-section of a profile-option apply to the option. Content modules included a sub-section of a profile apply to the profile.

[#semantic-profile-ref-use-case]
==== Referencing use-cases

A profile, or profile-option, references a <<semantic-use-case,use-case>> with the `sdpi_include_use_case` [include processor](https://docs.asciidoctor.org/asciidoctorj/latest/extensions/include-processor/) and declares the actor and obligation of the actor for the profile. Include the use-case for each actor with an obligation in the profile. For example:

[source,asciidoc]
----
sdpi_include_use_case::stad[actor-id="discovery-proxy", support=required]
sdpi_include_use_case::stad[actor-id="somds-consumer", support=required]
sdpi_include_use_case::stad[actor-id="somds-provider", support=required]
----

Note, specify the:

* <<semantic-use-case,use case>> id as the directive target (e.g., `stad`),
* <<semantic-actors,actor's>> id using the `actor-id` attribute,
* obligation of the actor in the `support` attribute (that is, `required` or `optional`). 

NOTE: Use-cases included in a sub-section of a profile-option apply to the option. Use-cases included a sub-section of a profile apply to the profile.

[#semantic-placeholder-transactions]
==== Placeholder transactions and content modules

Placeholder transactions and content modules may be created within profiles, or profile-options, to reference transactions and modules that are not yet specified. 

Use the second form of the <<semantic-profile-ref-transactions,`sdpi_include_transaction`>> [include processor](https://docs.asciidoctor.org/asciidoctorj/latest/extensions/include-processor/) and add a `placeholder-name` attribute. For example:

[source,asciidoc]
----
sdpi_include_transaction::DEV-26[actor-id="somds_consumer",initiator="required",placeholder-name="Discover system context and capabilities"]
----

Similarly, for placeholder content modules:

[source,asciidoc]
----
sdpi_include_content_module::anaesthesia[actor-id="biceps_content_creator",support="optional",placeholder-name="Anaesthesia devices SDC/BICEPS content module"]
----

Placeholders do not require a <<semantic-transactions,transaction>> or <<semantic-content-modules,content module>> definition. The `placeholder-name` is required each time the placeholder is used—when setting obligations for different actors, for example—however. 

[#semantic-profile-actor-alias]
==== Actor aliases

The document processor generally discovers actors referenced in <<semantic-requirements,requirements>> using <<cross-referencing,semantic cross-references>>. 

For backwards compatibility, a relationship between document ids (e.g., `vol1_spec_sdpi_p_actor_biceps_content_creator`) and actor-ids can be established by including the `actor-alias` role on sections defining ids that should be considered aliases for actors. 

This example, defines an <<semantic-actor,actor>> with the id `somds-participant` on the section with a role of `actor` and creates two alias for this actor (`vol1_clause_sdpi_p_somds_participant` and `vol1_spec_sdpi_p_actor_somds_participant`) by including the `actor-alias` role on the sections where these document ids are defined:

[source,asciidoc]
----
[#vol1_clause_sdpi_p_somds_participant, role="actor actor-alias",actor-id="somds-participant"]
==== SOMDS Participant

[#vol1_spec_sdpi_p_actor_somds_participant]
[reftext='SOMDS Participant',role="actor-alias",actor-id="somds-participant"]
Actor Summary...
----

NOTE: specify the <<semantic-actors,actor's>> id using the `actor-id` attribute.


[#semantic-transactions]
=== Defining transactions

The example below illustrates the AsciiDoc source required to define a transaction with two actors. 

[source,asciidoc]
----
[#vol2_clause_dev_23, role="transaction", transaction-id="DEV-23", reftext="Announce network presence",oid-arcs=".23.1,.23"]
=== Announce Network Presence [{var_transaction_id}]

==== Scope

Notify all SOMDS Consumers that a SOMDS Provider is ...

==== Actor Roles

[sdpi_transaction_actors]
--

[actor-id="somds-provider", contribution="Initiator"]
Announces its presence by multicasting vol2_clause_dev_23_message_hello messages to all listening systems.

[actor-id="somds-consumer", contribution="Receiver"]
Listens for vol2_clause_dev_23_message_hello messages to identify any <<vol1_spec_sdpi_p_actor_somds_provider>>s that it may exchange messages with and further retrieve a <<vol1_spec_sdpi_p_actor_somds_provider>>'s service capabilities.

--
----

Attaching the `transaction` role to a section marks it as a [transaction](https://profiles.ihe.net/DEV/SDPi/index.html#vol2). A (document-unique) identifier must be defined in the `DEV-23` attribute. The `reftext` attribute is used for the transaction label in tables, etc. 

The transactions object identifier (oid) may <<defining-oids,be set>> using the `oid-arcs` attribute. If not present, object identifiers will 
be set automatically from the transaction id. When assigned automatically, two oids will be applied to each transaction:

1. `<parent oid for DEV transactions>.<transaction-id>`, and 
2. `<parent oid for DEV transactions>.<transaction-id>.<version>`. `<version>` is (currently) 1. 

Transaction sections must define roles actors contribution within a `sdpi_transaction_actors` block:

[source,asciidoc]
----
[sdpi_transaction_actors]
--
   :
   :
--
----

The contribution actors make to the transaction are defined by a paragraph with `actor-id` and `contribution` attributes. The paragraph describes the contribution and/or role the actor will make to the transaction. The `actor-id` attribute provides the <<semantic-actors,actor's identifier>> while the `contribution` attribute provides the contribution the actor will make to the transaction. Available contributions are listed in the table below. 

|===
| Contribution | Actor's responsibility

| `initiator` | Steps that start the transaction (e.g., send a message to request information such as a provider's capabilities)
| `responder` | Provide a response to complete the transaction (e.g., provide the information requested in the message)
| `receiver`  | Consume the information provided to support the actor's core-functions; no response is required. 
|===

NOTE: actor's obligations and transactions used by profiles are included in the <<semantic-profile,Profile definition>>.

NOTE: `RefTransaction:<transaction-id>[]` may be used to <<cross-referencing,cross-reference>> transactions by id  (e.g., `RefTransaction:DEV-23[]`).  

[#semantic-requirements]
=== Defining requirements

The example below illustrates the AsciiDoc source to define a simple requirement. 

[source,asciidoc]
----
.R1021
[sdpi_requirement,sdpi_req_level=shall,sdpi_req_type=tech_feature,sdpi_req_group="provider,discovery-proxy",sdpi_req_specification=sdpi-p]
****

[NORMATIVE]
====
When the managed discovery option is enabled for a SOMDS provider, then it SHALL use the DEV-46 transaction to update the discovery proxy actor of its network presence and departure.
====

****
----

The block name, `sdpi_requirement`, triggers semantic processing for the requirement content while the https://docs.asciidoctor.org/asciidoc/latest/blocks/add-title/[block title] defines the requirement number. Various <<requirement-attributes,attributes>> define properties for the requirement. The requirement content is delimited by exactly four *'s. The only required content for a block is the normative statement, tagged with the block name `[NORMATIVE]` and delimited by exactly four ='s. With this information we can:

* perform basic requirement validation, such as checking level keywords in the normative text,
* generate a unique <<requirement-oids,ISO object identifier>> for each requirement,
* generate implementation conformance statement <<generate-table,tables>> with a list of requirements for selected groups,
* ensure all requirement numbers are unique,
* ...

Although the normative statement is the only block needed to define a requirement, many requirements include explanatory notes, examples and related information. This additional information is captured in tagged content blocks as the example below illustrates. This semantic content is retained when the requirements are exported in JSON format. 

[source,asciidoc]
----
.R1023
[sdpi_requirement,sdpi_req_level=shall,sdpi_req_type=tech_feature,sdpi_req_group="consumer,discovery-proxy",sdpi_req_specification=sdpi-p]
****

[NORMATIVE]
====
When the managed discovery option is enabled for a SOMDS consumer, then it shall use the DEV-47 transaction to retrieve SOMDS provider network presence metadata from the Discovery Proxy actor.
====

[NOTE]
====
. When retrieving network presence metadata from a discovery proxy actor, a discovery scope may be specified as a filter to identify a specific subset of SOMDS provider systems.
. A SOMDS consumer may optionally use the DEV-47 transaction to subscribe to all metadata updates from a set of SOMDS consumer systems, essentially using the discovery proxy as a pass-through for SOMDS provider DEV-23 and DEV-24 transactions. 
====

[EXAMPLE]
====
This is an example of an example block. 
====

[RELATED]
====
<<ref_oasis_ws_discovery_2009>>, section 2.2.2 Managed mode.
====

****
----

==== Requirement numbering

Requirement numbers are parsed from the title of the `sdpi_requirement` block. They must match the regular expression `^([A-Z])*?R(\\d+)$`. That is, a sequence of upper-case characters followed by `R` then a numeric value. Examples of valid requirement titles include: `.R1002`, `.TR1002`, `.ABCDEFR1002`. Invalid requirement titles include `.r1234` (an upper-case `R` is required), `.ABC R1234` (spaces are not permitted), `.tR1234` (lower-case letters are not permitted). <<cross-referencing,Cross-references>> (links) to a requirement may be inserted with in-line macros. 

NOTE: The `.` character marks the line as an AsciiDoc https://docs.asciidoctor.org/asciidoc/latest/blocks/add-title/[title]; it must begin in the first column of the source file. 

NOTE: Requirements are identified by number only. They are preserved but do not form part of the requirement identifier. 

NOTE: Previously anchors were needed, for cross-referencing, when defining a requirement (e.g., `[sdpi_requirement#r1022,sdpi_req_level=shall]`). These are now generated automatically. 

[[requirement-attributes]]
==== Block attributes

Block attributes supply metadata for the requirement. Attributes are tabulated below; additional information may be found in https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_requirement_type_requirement_definition[SDPi requirement type definitions].

|===
|Attribute | Applies to | Type | Required |Description

|`sdpi_req_type` | all | { `tech_feature` \| `ref_ics` \| `use_case_feature` \| `risk_mitigation` \| `ihe_profile` } | yes | Defines the type of requirement, from the https://profiles.ihe.net/DEV/SDPi/index.
|`sdpi_req_level` | all | {`shall` \| `should` \| `may` } |yes | Defines the behaviour expected for compatible implementations. html#vol1_clause_sdpi_requirements_core_model[SDPi requirements core model]
|`sdpi_req_group` |  all | comma separated list | no | Defines membership of ad-hoc groups. Groups may be used to select related requirements when generating ICS tables. 
|`sdpi_req_specification` |  all | defined _specification id_| yes| Defines the root for the requirements <<requirement-oids,ISO object identifier>>. 
|`sdpi_use_case_id` | `use_case_feature` | defined _use-case id_ | yes | Defines the use-case that the requirement applies to. Automatically populated from the enclosing <<use-case>> section. 
|`sdpi_ref_id` | `ref_ics` | defined _reference id_ | yes | The bibliography anchor for the entry to the referenced requirement.
|`sdpi_ref_section` | `ref_ics` | section identifier | yes | The identifier for the section containing the referenced requirement.
|`sdpi_ref_req` | `ref_ics` | requirement identifier | yes | The identifier for the requirement in the referenced standard. 
|`sdpi_ses_type` | `risk_mitigation` | {`general` \| `safety` \| `effectiveness` \| `security` \| `audit` } | yes | https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_requirement_type_ses[Type of risk] the requirement mitigates. 
|`sdpi_ses_test` | `risk_mitigation` | {`inspect` \| `wire` } | yes | Mechanism for testing the requirement. 
|`sdpi_max_occurrence`| all | integer | no | Placeholder.
|===

[[requirement-oids]]
==== ISO object identifiers

ISO object identifiers (OIDs) are assigned and rendered with each requirement in the output file generated. They are used as the primary requirement id in implementation conformance statement tables. ISO object identifiers combine a profile- or standard-specific root identifier with requirement number, that is: `profile_oid.2.requirement_number`. The profile/standard is identified, by name, using the `sdpi_req_specification` attribute. Relationships between profile/standard names and their ISO object identifier is established using document level `sdpi_oid` scoped attributes, typically in `asciidoc/std-oid-definitions.adoc`. 

Named profile and standards include:

|===
| Specification (`sdpi_req_specification`) | Profile/standard

| `sdpi` | The https://profiles.ihe.net/DEV/SDPi/index.html[SDPi] profile
| `sdpi-p` | The https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_p_profile[SDPi plug-and-trust] profile
| `sdpi-a` | The https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_a_profile[SDPi alerting] profile
| `sdpi-r` | The https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_r_profile[SDPi reporting] profile
| `sdpi-xC` | The https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_xc_profile[SDPi external control] profile
|===

Refer to the document source for corresponding ISO object identifiers for each profile. 

NOTE: specification names are case-sensitive. 

==== Groups

There is currently (February 2025) no constraint on groups that may be assigned to requirements. However, to promote consistency and utility, the following groups are recommended.

|===
| Group id | Description

| consumer | Applies to https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_p_somds_consumer[SOMDS consumer] implementations. 
| provider | Applies to https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_p_somds_provider[SOMDS provider] implementations.
| discovery-proxy | Applies to https://profiles.ihe.net/DEV/SDPi/index.html#_discovery_proxy[managed discovery proxy] implementations.
|===

NOTE: Group names are case sensitive.

==== Ownership

Requirement ownership is included in the `sdpi-requirements.json` artefact to requirement discovery (e.g., all requirements an actor must support). Requirements may be owned by a <<semantic-profile,profile>>, profile-option, <<semantic-content-module,content-module>>, gateway, protocol or <<semantic-use-case,use-case>>. Requirement ownership is automatically determined from the parent section (that is, a parent section with one of the <<semantic-markup,roles>> supported for ownership). 

[[use-case]]
=== Defining use cases

Use case blocks, and their parts, are identified in the source by AsciiDoc https://docs.asciidoctor.org/asciidoc/latest/attributes/role/[roles], with metadata provided in block attributes. The following example AsciiDoc source defines a use-case and one scenario. 

[source,asciidoc]
----
[role="use-case",sdpi_use_case_id=stad]
[sdpi_feature="Synchronized Time Across Devices"]
=== Use Case Feature 1: Synchronized time across devices (STAD)

==== Narrative
Nurse Jean attaches a ventilator to the medical device network in the ICU.  It automatically obtains the correct time.

==== Benefits
Automatically acquiring the time saves the user from spending time entering the time into the device.  It also guarantees that the correct time will be entered.
It is also important for all devices to have a consistent time since the data being exported to consuming devices and systems will use the time stamps from the device to mark the time that the clinical data was acquired.  Since this is part of the clinical record, accuracy is very important.

==== Technical Pre-Conditions

[role=use-case-background]
====
*Given* All devices communicate using a common acronym_md_lan protocol

*And* A Time Source (TS) Service is on the acronym_md_lan network
====

==== Scenarios

[role=use-case-scenario,sdpi_scenario="Device is connected to the MD LAN network with a Time Source service"]
===== Scenario: STAD 1.1 --- Device is connected to the MD LAN network with a Time Source service

[role=use-case-steps]
====
*Given* Device has detected at least one TS Service

*When* The TS Service is operational

*Then* The device will synchronize its time with the TS Service
====

----

[[use-case-roles]]
==== Block roles

AsciiDoc https://docs.asciidoctor.org/asciidoc/latest/attributes/role/[roles] assigned to content blocks provide semantic structure to use-case definitions. The roles available for use-cases are shown in the table below. 

Along with roles, use-case blocks should be logically structured in document sections. That is, background and scenarios must be sub-sections of a use-case section; steps must be within a scenario section. This structure is used to associate each content block with the appropriate use-case/scenario. 

Each use-case must have at most one background section and zero or more scenarios. Each scenario section must have at most one steps content block (which may contain several <<use-case-steps,steps>>).

|===
|Role | Parent | Content block

| `use-case` | &mdash; | Defines a use-case feature. 
| `use-case-background` | `use-case` | Defines technical pre-requisites for a use-case. 
| `use-case-scenario` | `use-case` | Defines one scenario in the use-case. 
| `use-case-steps` | `use-case-scenario` | Defines steps for a use-case scenario. 
|===

[[use-case-attributes]]
==== Block attributes

Block attributes supply metadata for the use-case. Attributes are tabulated below; additional information may be found in https://profiles.ihe.net/DEV/SDPi/index.html#vol1_clause_sdpi_requirement_type_requirement_definition[SDPi requirement type definitions].

|===
|Attribute | Applies to role | Type | Required |Description

|`sdpi_use_case_id` | `use-case` | _unique id_ | yes | Defines an id for referencing the use case in requirements and cross-referencing. Must be globally unique.
|`sdpi_use_case_scenario` |  `use-case-scenario` | _unique id_ | yes | Defines an id for one sequence in a use case. Must be unique within the use-case. 
|===

NOTE: Ids are case-sensitive. 

[[use-case-steps]]
==== Defining steps

Steps, in background and steps content blocks, are defined in paragraphs prefixed by https://cucumber.io/docs/gherkin/reference/[Gherkin] keywords. Keywords are parsed (e.g., for exporting rich JSON data). Supported steps are shown in the table below. Steps are not case-sensitive. 

|===
|Keyword | Description

| *given* | Initial context of the system, typically something that happened in the past. 
| *when* | An action or event that triggers the scenario.
| *then* | Expected outcome from the scenario.
| *and* | Conjunction, used with *when* or *then* for an additional trigger/outcome that is also expected.
| *or* | Conjunction, used with *when* or *then* for an alternate trigger/outcome. 
|===

[#semantic-content-modules]
=== Defining content modules

The example below illustrates the AsciiDoc source required to define a content module for the document processor. 

[source,asciidoc]
----
[#vol3_clause_sdc_biceps_semantic_content_module,role="content-module", content-module-id="biceps"]
===== SDC/BICEPS Content Module

The biceps standard, <<ref_ieee_11073_10207_2017>>, provides an extensive semantic...
----

Attaching the `content-module` role to a section marks it as a [content module](https://profiles.ihe.net/DEV/SDPi/index.html#vol3). A (document-unique) identifier must be defined in the `content-module-id` attribute. The section title is used for the content module label. 

NOTE: `RefContentModule:<content-module-id>[]` may be used to <<cross-referencing,cross-reference>> transactions by id (e.g., `RefContentModule:biceps[]`). 

[#semantic-protocols]
=== Defining protocols

The example below illustrates the AsciiDoc source required to define a protocol for the document processor. 

[source,asciidoc]
----
[role="protocol",protocol-id=mdpws]
== ISO/IEEE 11073 SDC / MDPWS Message Specifications (Normative)

[CAUTION]
====
Message outlines do not contain ...
====
----

Attaching the `protocol` role to a section marks it as a communication protocol. A communication protocol defines how SOMDS information is exchanged between participants, such as SOAP-based web services. A (document-unique) identifier must be defined in the `protocol-id` attribute. The section title is used for the protocol label. 


[[defining-oids]]
=== Defining object identifiers (oids)

Many items require object identifiers (oids) including:

* profiles,
* actors, and
* transactions. 

There is a https://wiki.ihe.net/index.php/PCD_OID_Management[canonical defnition of object identifiers for IHE DEV domains].

Use the `oid-arcs` attribute on blocks that define items. The example below illustrates setting an oid for the participant actor.

[source,asciidoc]
----
[role="actor",actor-id="somds_participant",oid-arcs=.40]
===== SOMDS Participant
  etc.
----

Only the leaf arc is required when the oid value begins with a `.`. The document processor automatically combines the leaf with the correct https://wiki.ihe.net/index.php/PCD_OID_Management#General_IHE-DEV_OID_Identifiers[parent oid], which depends on the item type. Arcs that do not begin with a `.` are applied verbatium. 

Multiple oids may be associated with an item by separating them with commas:

[source,asciidoc]
----
[role=transaction,transaction-id=DEV-23,oid-arcs=".23.1,.23"]
=== Announce Network Presence [{var_transaction_id}]
  etc.
----


[[cross-referencing]]
=== Cross-referencing

It is common to refer to requirements and use-cases from elsewhere in the source. Semantic https://docs.asciidoctor.org/asciidoctorj/latest/extensions/inline-macro-processor/[in-line macros] are provided to cross-reference requirements and use-cases by their requirement number and use-case id, respectively. 

|===
|Macro name | Target | Optional attributes | Example | Description

|`RefRequirement` | requirement | _none_ | `RefRequirement:r1002[]` | Inserts a link to the requirement target. 
|`RefUseCase` | use-case | _none_ | `RefUseCase:stad[]` | Inserts a link to the use-case target. 
|`RefActor` | actor | _none_ | `RefActor:discovery-proxy[]` | Inserts a link to the actor definition in a profile. 
|`RefProfile` | profile or profile option | _none_ | `RefProfile:SDPi-P[]`, `RefProfile:SDPi-P[profile-option-id="discovery proxy"]` | Inserts a link to the profile or profile option. 
|`RefContentModule` | content module | _none_ | `RefContentModule:biceps[]` | Inserts a link to the content module. 
|`RefTransaction` | transaction | _none_ | `RefTransaction:DEV-23[]` | Inserts a link to the transaction definition.
|===

NOTE: use case ids are case-sensitive.

IMPORTANT: Using the in-line macro reduces the risk of broken links and helps ensure future compatibility if, for example, <<requirement-oids,ISO object identifiers>> are used to reference requirements. 

[[generate-table]]
=== Summary tables

Summary tables are automatically generated during document processing and inserted in place of https://docs.asciidoctor.org/asciidoctorj/latest/extensions/block-macro-processor/[block macros]. The tables available are:

|===
|Table | Macro | Columns

|Implementation conformance statement table | `sdpi_ics_table` | index, reference, status, support, comment
|Requirement list | `sdpi_requirement_table` | <<requirement-oids,ISO object identifiers>>, local requirement id, level, type
|Profile actors and transactions | `sdpi_transaction_table` | Actor, Transaction, Contribution, Obligation, Option
|Profile actors and content modules | `sdpi_content_module_table` | Actor, Content module, Obligation, Option
|Object identifiers | `sdpi_oid_table` | Oid, Type, Description
|===


NOTE: Requirement tables may be included at any point in the source (where block-macros are allowed). They will gather requirements from the entire document. It is not necessary to define requirements before they can be included in a table. 

The example below includes an ICS table in the generated document with all requirements in the `provider` group. 

[source,asciidoc]
----
sdpi_ics_table::[sdpi_req_group=provider]
----

==== Filter

Filter parameters, included as named attributes, select the content included in the table. Available filters are tabulated below. 

|===
|Attribute name | Applies to | Value | Obligation | Description

|`sdpi_req_group` | `sdpi_requirement_table`, `sdpi_ics_table` | comma separated list | optional | Includes requirements with any of the groups supplied in their `sdpi_req_group` <<requirement-attributes,attribute>>. 
|`profile-id` | `sdpi_transaction_table`, `sdpi_content_module_table` | _profile id_ | required | Table includes details for the selected profile.
|`profile-option-id` | `sdpi_transaction_table`, `sdpi_content_module_table` | _profile option id_ | required | Table includes details for the selected profile option only. If not specified all options are included.
|`actor-id` | `sdpi_transaction_table`, `sdpi_ics_table` | _actor id_ | required | Table includes only transactions for the selected actor. 
|`arc` | `sdpi_oid_table` | _arc id_ | `actors`, `transactions` or `profiles` | Table only includes oids for the selected arcs. 

|===

=== Backwards compatibility

Some changes to the supplement source text are required to take advantage of the new features including additional attributes on requirements and tagging use cases. To ease adoption, the new extensions fallback to the original behaviour. This means, the

. processor works with the original supplement source without any modifications, and
. output from the original supplement is largely identical following addition of new processor features as it was before the new features were added. The generated html is the same (at the byte level) except:
.. the `Build Date` entry will be different on the title page and in the footer,
.. requirement `div` blocks get an extra `requirement` style class. That is, for example, `<div id="r1021" class="sidebarblock requirement">` instead of `<div id="r1021" class="sidebarblock">`,
.. added https://gitlab.com/antora/antora-ui-default/-/blob/master/src/js/06-copy-to-clipboard.js[copy2clipboard.js] to support copying links to requirement anchors for easy cross-referencing.

== Document generation

The AsciiDoc source is automatically processed using GitHub actions. 

For testing, documents can be generated using Windows command line tools (probably for other operating systems too, but I don't know about that; please expand on this when you figure out how). To create output from the AsciiDoc source open a command prompt in the `.ci\asciidoc-converter` folder and use:

* `build_document.bat` to create an html document (`sdpi-supplement.html`),
* `build_document_pdf.bat` to create an Acrobat PDF document (`sdpi-supplement.pdf`).

The output files are written to `sdpi-supplement` folder. Extracts (requirements and use-cases in JSON format) are written to the `sdpi-supplement\referenced-artifacts` folder. Extracts are generated along with the document output. 

IMPORTANT: Don't commit files in the `sdpi-supplement` folder to the repository. 

== Topics Parking Lot

Include:

Add:  Continuous Build process documentation ... for multi-file / multi-page AsciiDoc sources
* Section Numbering & Naming Conventions
Much of this is specified in the IHE template, but
see "depth" and discontinuous section numbering issues

Capture:  indicate section depth + offset using something like ...

[#the_id,sdpi_num_offset=10] and

[#the_id,sdpi_num_level=+1]  depth indicator

Also factor in Figure and Table numbering:  section number + "-1" | "-2" ...

* Non-section Number Based / cross-doc References



* IHE TF UML Model

Include something that shows the interrelationships between blocks of content.

IMPORTANT: TBD - __Need to determine how to formalize these kinds of UML models; drawn in "Magicdraw", to PNG, to XMl rep of some sort (collapsable inclusion?), used for this doc + for SST database extraction / processing __

* Mapping from UML to AsciiDoc Block Content

** All special blocks should include a UML model for their content and be represented in the general TF UML model
** Classes represent blocks (including referenced classes)
** Class data elements represent block content
** Contained classes represent nested block content that can have cardinality
** ...

* Reference Conventions (basic syntax, conventions)

* Block basics
* Block naming conventions
* Block types

** IHE TF Elements (with URI identifiers) - see UML Models

*** Profile + Profile Option
*** Actor + Actor Option + TF-0 Summary
*** Transaction (TF-0 summary + TF-2 detail)
*** Issues / Open & Closed (w/ ToI links & github Issue links)
*** TF-0 Glossary - Term of Art
*** BICEPS specification (e.g., XML for a specialization OR for a )
*** ...

** RI "link" blocks  (note: separate article proposed ... needed?)
** Requirement blocks
** SES blocks + subsections
** Use Case (Gherkin structured + General Appx. C & profile specific) - see UML model

NOTE:  Include UML model for each block type (per above)

* Block "tagging regions" to omit all from production
** See https://docs.asciidoctor.org/asciidoc/latest/directives/include-tagged-regions/#tagging-regions[AsciiDoc "Tagging regions" article] for conditional logic that can be used to include source content that is not passed through to the printed document
** See https://docs.asciidoctor.org/asciidoc/latest/blocks/delimited/#nesting[AsciiDoc "Nesting blocks" article]

NOTE:  For quick links and examples for AsciiDoc constructs that are used in the SDPi Supplement, see the wiki article:  https://github.com/IHE/sdpi-fhir/wiki/SDPi-Editors-AsciiDoc-Cheat-Sheet.asciidoc[_SDPi Editors' AsciiDoc Cheat Sheet_]

{empty} +

